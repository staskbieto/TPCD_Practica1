---
title: "PAC4 - Anàlisi de la variància i repàs del curs"
author: "Pol Bieto Luengo"
date: "16/7/2020"
output: 
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
---

******
# <strong>Estadística descriptiva i visualització</strong>
******

## Tipus de dades

>Comproveu el tipus de variable que correspon a cada una de les variables. Quines són tipus numèric? Quines són tipus factor? Hi ha dades faltants?

```{r,eval=TRUE,echo=TRUE}
datatata <- read.csv("dades.csv",fileEncoding="ISO-8859-1")

usTable<- table(datatata$Sexo)
labs<- paste(names(usTable), " (", usTable,")", sep="")
pie(usTable, labels = labs, main="Sexe")

boxplot(datatata$SE,main="SE", col="gray")

boxplot(SE~Sexo,
  data=datatata,
  main="",
  xlab="Sexe",
  ylab="SE ",
  col="blue",
  border="purple"
)

library("papeR")
library(knitr)
library(kableExtra)
tableSummarize<- summarize(datatata,variables=c("SE"))
tableSummarize$IQR<- tableSummarize$Q3-tableSummarize$Q1
kable(tableSummarize) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```
```{r,eval=TRUE,echo=TRUE}
childrenSeatsDataFrame <- read.csv("ChildCarSeats.csv",fileEncoding="ISO-8859-1")
summary(childrenSeatsDataFrame)
str(childrenSeatsDataFrame)

colnames(childrenSeatsDataFrame)[!complete.cases(t(childrenSeatsDataFrame))]
```
Com a variables numèriques tenim Sales i com a enters tenim CompPrice, Income, Advertising, Population, Price, Age i Education. Pel altre banda, ShelveLoc, Urban i US són del tipus factor. No hi falta cap dada de cap observació.

## Resum de dades quantitatives

>Realitzeu una taula de les dades quantitatives on apareixi la mitja, la mitjana, la desviació standard i
  l’amplitud interquartílica (IQR, en anglès). Comenteu els resultats.
  
```{r,eval=TRUE,echo=FALSE, results="asis"}
library("papeR")
library(knitr)
library(kableExtra)
tableSummarize<- summarize(childrenSeatsDataFrame,variables=c("Sales","CompPrice","Income","Advertising","Population","Price","Age","Education"))
tableSummarize$IQR<- tableSummarize$Q3-tableSummarize$Q1
kable(tableSummarize) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```
De la taula anterior podem destacar algunes variables que presenten una gran dispersió. El cas més notable és el de Advertising, on tenim una desviació estàndard gairebé igual a la mitja, amb un IQR de quasi el doble i una diferència notable entre mediana i mitjana, fet que denota que la distribució no és simètrica. La dispersió de les dades la tenim també, en menor mesura, amb Population i income. 

## Diagrama de caixa

>Mostreu amb diversos diagrames de caixa la distribució de la variable Sales segons: ShelveLoc, Urban i US. Interpretar els gràfics breument.

```{r,eval=TRUE,echo=TRUE}
boxplot(Sales~ShelveLoc,
  data=childrenSeatsDataFrame,
  main="Vendes segons la posició al prestatges",
  xlab="Posició als prestatges",
  ylab="Vendes (milers)",
  col="orange",
  border="brown"
)
```

Veiem l'efecte positiu que presenta aquesta variable, ja que a mesura que millora la posició als prestatges, la mitjana en vendes també augmenta.

```{r,eval=TRUE,echo=TRUE}
boxplot(Sales~Urban,
  data=childrenSeatsDataFrame,
  main="Vendes segons si és ubicació urbana",
  xlab="Ubicació urbana?",
  ylab="Vendes (milers)",
  col="blue",
  border="purple"
)
```

En aquest cas, visualment no s'aprecia una gran diferència en quant a la ubicació urbana i les vendes.

```{r,eval=TRUE,echo=TRUE}
boxplot(Sales~US,
  data=childrenSeatsDataFrame,
  main="Vendes segons si és dins d'EUA o al exterior ",
  xlab="Als EEUU?",
  ylab="Vendes (milers)",
  col="yellow",
  border="green"
)
```

Aquí sí s'aprecia un lleugera diferència a les vendes segons si es produeixen dins o fora dels EUA.

## Representació gràfica de les variables qualitatives.

```{r,eval=TRUE,echo=TRUE}
urbanTable<- table(childrenSeatsDataFrame$Urban)
labs<- paste(names(urbanTable), " (", urbanTable,")", sep="")
pie(urbanTable, labels = labs, main="Vendes en nuclis urbans?")
```

Veiem que la gran majoria de vendes es produeixen en nuclis urbans.

```{r,eval=TRUE,echo=TRUE}
usTable<- table(childrenSeatsDataFrame$US)
labs<- paste(names(usTable), " (", usTable,")", sep="")
pie(usTable, labels = labs, main="Vendes als EEUU?")
```

El principal mercat és als EUA.

```{r,eval=TRUE,echo=TRUE}
shelveLocTable<- table(childrenSeatsDataFrame$ShelveLoc)
labs<- paste(names(shelveLocTable), " (", shelveLocTable,")", sep="")
pie(shelveLocTable, labels = labs, main="Vendes segons la bondat de la posició als prestatges")
```

Veiem que més de la meitat de les vendes provenen de productes exposats a una situació mitjana a les botigues en quant a la seva posició.

******
# <strong>Estadística inferencial</strong>
******

## Interval de confiança de la variable Price

> Calculeu l’interval de confiança al 95% de la variable Price. A partir del valor obtingut, expliqueu com s’interpreta el resultat de l’interval de confiança.


```{r,eval=TRUE,echo=TRUE}
S <- function(data){
  median <- median(data)
  n <- length(data)
  n_factor<- 1/(n-1)
  suma <- sum((data-median)^2)
  result <- sqrt(n_factor*suma)
}
IC <- function(data,confidence) {
  median <- median(data)
  n <- length(data)
  s <- S(data)
  
  P<-(1-confidence)/2
  t_star<- qt(1-P, df=(n-1))
  
  final_factor <- t_star*(s/sqrt(n))
  c(median-final_factor,median+final_factor)
}
intervalPreu<- IC(childrenSeatsDataFrame$Price,0.95) 
```
Tenim que, per la mostra donada, la mitjana de preu es troba entre els `r round(intervalPreu[1],1)`\$ i els `r round(intervalPreu[2],1)`\$. Això vol dir que si es prenen diferents mostres de la població, el 95% dels intervals calculats contenen el valor del paràmetre preu mitjà.

## Test de comparació de dues mitjanes
>Es pot acceptar que en les botigues d’EUA (variable US) la mitjana de vendes del seients de cotxes infantils (variable Sales) és superior a la mitjana de vendes en botigues fora d’EUA? Calculeu per a un nivell de confiança del 95%.

### Hipòtesi
En aquest cas definirem la hipòtesis nul·la de la següent manera:

 $$H_0 : μ_1 = μ_2$$

La hipòtesis alternativa és doncs, com a hipòtesi bilateral:

$$H_1 : μ_1 ≠ μ_2$$

###  Assumpció de normalitat
Es pot aplicar el teorema del límit central pel qual la distribució de la mitjana mostral d’una mostra prou gran és aproximadament normal. A més, la mitjana serà la mateixa que la variable d’interès i la desviació típica de la mitjana mostral serà aproximadament l’error estàndard.

### Justificar quin mètode aplicareu
Aplicarem un contrast bilateral de dues mostres independents sobre la mitjana. Donat que no podem assegurar que les mostres provinguin de poblacions normals, utilitzarem l'estadístic de contrast Z ja que gràcies al teorema del límit centrals ens assegura que per mostres grans (majors a 30 observacions), es distribueix aproximadament com una N(0,1)
$$
\begin{aligned}
\frac{\overline{x}_1-\overline{x}_2}{\sqrt{
\frac{S_1²}{n_1}+\frac{S_2²}{n_2}
}}
\end{aligned}
$$

També s'ha escollit aquest mètode ja que no podem assegurar que les variàncies poblacionals siguin iguals. Si realitzem el F-test veiem que obtenim un p-value molt petit, i per tant, hem de rebutjar la hipòtesis nul·la. 

```{r,eval=TRUE,echo=TRUE}
var.test(x = childrenSeatsDataFrame$Sales[childrenSeatsDataFrame$US=="Yes"],
         y = childrenSeatsDataFrame$Sales[childrenSeatsDataFrame$US=="No"])
```

### Realitzar els càlculs de l’estadístic de contrast, valor crític i p valor amb un nivell de confiança del 95%

```{r,eval=TRUE,echo=TRUE}
ztest_contrastDosMostres <-
  function(x_1,
           x_2,
           confidence = 0.95,
           alternative = "two.sided") {
    alfa <- (1 - confidence)
    mean_1 <- mean(x_1)
    mean_2 <- mean(x_2)
    
    n_1 <- length(x_1)
    n_2 <- length(x_2)
    
    sd_1 <- sd(x_1)
    sd_2 <- sd(x_2)
    
    z <- (mean_1 - mean_2) /  sqrt(sd_1 ^ 2 / n_1 + sd_2 ^ 2 / n_2)
    if (alternative == "two.sided") {
      critical <- qnorm(alfa / 2, lower.tail = FALSE)
      pvalue <- pnorm(abs(z), lower.tail = FALSE) * 2
    }
    else if (alternative == "less") {
      critical <- qnorm(alfa, df, lower.tail = TRUE)
      pvalue <- pnorm(z, df, lower.tail = TRUE)
    } else if (alternative == "greater") {
      critical <- qnorm(alfa, lower.tail = FALSE)
      pvalue <- pnorm(z, lower.tail = FALSE)
    }
    data.frame(
      "Contrast" = z,
      "Valor crític" = critical,
      "P-value" = pvalue
    )
  }

contrast323<- ztest_contrastDosMostres(childrenSeatsDataFrame$Sales[childrenSeatsDataFrame$US =="Yes"],
                         childrenSeatsDataFrame$Sales[childrenSeatsDataFrame$US == "No"],
                         alternative = "two.sided")

contrast323 %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover"))
```
Amb els següents resultats rebutgem la hipòtesis nul·la ja que el valor observat o de contrast no es troba dins la regió d'acceptació del valor crític. Arribem a la mateixa conclusió amb el p-value, inferior a la significació del 0.05

## 3.3 Contrast no paramètric

>En l’apartat anterior hem assumit la normalitat de la variable vendes (Sales). Ara apliqueu un test no paramètric per respondre la mateixa pregunta anterior. Podeu usar una funció R per resoldre el contrast.

```{r,eval=TRUE,echo=TRUE}
wilcox.result <- wilcox.test(childrenSeatsDataFrame$Sales[childrenSeatsDataFrame$US =="Yes"],  childrenSeatsDataFrame$Sales[childrenSeatsDataFrame$US == "No"])
wilcox.result
```
### Interpreteu el resultat

Amb el resultat de la prova dels signes de Wilcoxon, que és un mètode d'estadística no paramètrica, alternatiu a la prova t de Student, que compara el rang mitjà de dues mostres per a determinar si existeixen diferències entre elles, arribem a la mateixa conclusió que en el cas anterior: hi ha evidència de diferencies significatives en les mitjanes.

******
# <strong>Regressió</strong>
******

## Model de regressió

>Apliqueu un model de regressió lineal múltiple que tingui com a variables explicatives: Price, Advertising, Age, Population, ShelveLoc, US, i Urban, i com a variable dependent les vendes, variable Sales. <br>
Especifiqueu el nivell base (usant la funció relevel): per a la variable ShelveLoc, la categoria “Bad”, per a la variable US, la categoria “Yes”, i per a la variable Urban, la categoria “Yes”.

```{r,eval=TRUE,echo=TRUE}
childrenSeatsDataFrame$ShelveLoc<- relevel(childrenSeatsDataFrame$ShelveLoc, ref="Bad")
childrenSeatsDataFrame$US<- relevel(childrenSeatsDataFrame$US, ref="Yes")
childrenSeatsDataFrame$Urban<- relevel(childrenSeatsDataFrame$Urban, ref="Yes")
liniarRegressionEx41 = lm(Sales~Price+Advertising+Age+Population+ShelveLoc+US+Urban, data = childrenSeatsDataFrame)
summary(liniarRegressionEx41)
```

## Interpretar el model
>Interpreteu el model ajustat. Expliqueu quina interpretació en feu de la contribució en el model de les variables regressores. Indiqueu com seria el model de regressió per una botiga fora d’EUA, no urbana i amb un ShelveLoc de tipus “Bad”

Analitzant el resultat de la regressió sembla que totes les variables tenen capacitat descriptiva en el model a excepció de Population, US i Urban. 

El model de regressió que tenim és el següent:

```{r,eval=TRUE}
formularEx41 <- 
  paste0("y ~ ", round(coefficients(liniarRegressionEx41)[1],4), "", 
    paste(sprintf(" %+ .4f* %s ", 
                  coefficients(liniarRegressionEx41)[-1],  
                  names(coefficients(liniarRegressionEx41)[-1])), 
          collapse="")
  )

formularEx41
```

On les variables categòriques en el model es representen per dummy variables. Això vol dir que, tenint en compte els nivells base escollits, si estem en una botiga no urbana, la variable UrbanNo serà 0, igual que si tenim ShelveLoc tipus "Bad", haurem de posar a 0 les variables ShelveLocMedium i ShelveLocGood. En el cas de la botiga fora d'EUA, la variable USNo serà igual a 1.

## Predicció

>Apliqueu el model de regressió per predir Sales d’una botiga fora d’EUA a una zona rural, amb Price de 131 dòlars, Advertising de 0 dòlars, Population de 139 milers de persones, Age de 40 anys i ShelveLoc de tipus ¨Bad¨.</br>
Compareu el resultat amb el d’una botiga fora d’EUA a una zona rural, amb Price de 131 dòlars, Advertising de 9 mil de dòlars, Population de 139 milers de persones, Age de 40 anys i ShelveLoc de tipus ¨Good¨.</br>
Expliqueu les diferències en funció dels coeficients del model de regressió.

```{r,eval=TRUE,echo=TRUE}
library(knitr)
library(kableExtra)

testData1 = data.frame(Urban="No", US='No', Price=131, Advertising=0,Population=139,Age=40,ShelveLoc='Bad')     
predict(liniarRegressionEx41, newdata = testData1, interval="predict") %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover"))

testData2 = data.frame(Urban="No", US='No', Price=131, Advertising=9,Population=139,Age=40,ShelveLoc='Good')     
predict(liniarRegressionEx41, newdata = testData2, interval="predict") %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover"))

```
Veiem que la segona predicció ens dona un valor més alt. La diferència està associada en el valor de Population i en ShelveLoc, en el primer cas "Bad" i en el segon "Good". Donat que el model creix més lentament en quant a la variable Population, el gruix de la diferència en el valor predit ve donat per la diferència en ShelveLoc, la posició del producte a la botiga.

******
# <strong> Anàlisi de la variància (ANOVA)</strong>
******
>Realitzeu un ANOVA per contrastar la significació de la variable ShelveLoc en la variable Sales.

## Anova d’un factor

### Vendes i qualitat de la localització dintre de l’expositor

>Realitzeu un ANOVA per contrastar la significació de la variable ShelveLoc en la variable Sales.

```{r,eval=TRUE,echo=TRUE}
aov511 <- aov(Sales~ShelveLoc,data=childrenSeatsDataFrame)
```

### Escriure la hipòtesis nul·la i alternativa

* Hipòtesis nul·la: Las mitjanes poblacionals de las tres submostres associades als tres nivells de la variable ShelveLoc són iguals.
* Hipòtesis alternativa: Les mitjanes poblacionals de les tres submostres no són iguals.

### Model. Calculeu l’anàlisi de variància, utilitzant la funció aov o lm. Interpreteu el resultat de l’anàlisi, tenint en compte els valors Sum Sq, Mean SQ, F i Pr (> F).
```{r,eval=TRUE,echo=TRUE}
summary(aov511)
```
Veient els resultats de l'anàlisis tenim que:

$$SDC_T= 832.8+2146.5 = 2979.3$$

$$SDC_E=832.8$$

$$SDC_I=2146.5$$
Els valors de la variança entre grups serà:
$$VE=MC_E=416.4$$
$$VI=MC_I=7.5$$
Això ens indica que tenim grups bens definits segons ShelveLoc. Al valor del estadístic F se li associa una probabilitat inferior al nivell de significació de 0.05. Podem concloure doncs que les mitjanes són significativament diferents. 
Al rebutjar la hipòtesi nul·la sabem que hi ha diferències entre les mitjanes, és a dir, que almenys una d'elles, sense determinar quina, és diferent a la resta. per completar l'anàlisi haurem d'establir entre quines categories es donen les diferències, així com la intensitat de la relació entre les variables.

### Càlculs
>a) Mostreu gràficament la distribució de vendes, Sales, segons el factor ShelveLoc ordenat segons la qualitat: “Bad”, “Medium” i “Good”. Pots fer servir la funció reorder.

```{r,eval=TRUE,echo=TRUE}
childrenSeatsDataFrame$ShelveLoc<- ordered(childrenSeatsDataFrame$ShelveLoc, levels =c("Bad", "Medium", "Good"))
boxplot(Sales~ShelveLoc,
  data=childrenSeatsDataFrame,
  main="Vendes segons la posició al prestatges",
  xlab="Posició als prestatges",
  ylab="Vendes (milers)",
  col="orange",
  border="brown"
)
```

>b) Per tal d’aprofundir en la comprensió del model ANOVA, calculeu manualment la suma de quadrats intra i la suma de quadrats entre grups. Els resultats han de coincidir amb el resultat del model ANOVA. Com a referència, pots obtenir les fórmules de López-Roldán i Fachelli (2015), pàgines 29-33.

```{r,eval=TRUE,echo=TRUE}
childrenSeatsDataFrame$ShelveLoc<- ordered(childrenSeatsDataFrame$ShelveLoc, levels =c("Bad", "Medium", "Good"))


sumSSQAnova<- function(data, varName, varResponse){
  k <- nlevels(data[[varName]])
  n <- nrow(data)
  mean<- mean(data[[varResponse]])
  groups <- split(data, data[[varName]])

  SCDT<- sum(data[[varResponse]]^2)-((sum(data[[varResponse]])^2)/n)
  SCDE<- sum(unlist(lapply(groups,  function(x){ nrow(x)*((sum(x[[varResponse]])/nrow(x))-mean)^2})))
  efectes<- lapply(groups,  function(x){ mean(x[[varResponse]])-mean})
  data.frame("SCDT" = SCDT, "SCDE" = SCDE, "SCDI" = SCDT-SCDE, "VI"=SCDT/(n-k), "VE"=SCDE/(k-1), "efectes"=  efectes)
}



sumSSQAnovaResult<-sumSSQAnova(childrenSeatsDataFrame,"ShelveLoc","Sales")
sumSSQAnovaResult  %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover"))
```

Veiem que obtenim els mateixos resultats.

>c) També proporcioneu l’estimació dels efectes dels nivells del factor ShelveLoc. I l’estimació de la variància de l’error.

En l'estimació dels efectes tenim:

```{r,eval=TRUE,echo=TRUE}
effects<- function(data, varName, varResponse){
  k <- nlevels(data[[varName]])
  n <- nrow(data)
  mean<- mean(data[[varResponse]])
  groups <- split(data, data[[varName]])
  unlist(lapply(groups,  function(x){ mean(x[[varResponse]])-mean}))
}


effects.shelveLoc<-effects(childrenSeatsDataFrame,"ShelveLoc","Sales")
effects.shelveLoc %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover"))
```
On veiem que el nivell "Bad" té un notable efecte negatiu, "Medium" està molt a prop de la mitjana mostral, i "Good" té un clar efecte positiu.

Pel que fa a la variança del error en el model, tenim:

$$VET = \frac{SCD_T}{N-1} = \frac{ 2979.3}{399} = 7.47$$


### Interpreteu els resultats
Com ja hem comentat anteriorment a la interpretació hi ha un clar efecte de la variable ShelveLoc en Sales.

##  Adequació del model

>Mostra visualment l’adequació del model ANOVA. Podeu fer servir plot sobre el model ANOVA resultant. En els apartats següents es demana la interpretació d’aquests gràfics.

```{r,eval=TRUE,echo=TRUE}
plot(aov511)
```

### Normalitat dels residus

>Interpreteu la normalitat dels residus a partir de l’gràfic Normal Q-Q que es mostra en l’apartat anterior.

Veiem que al gràfic Q-Q que els residus tenen un comportament normal ja que segueixen una distribució homogènia al voltant del model lineal calculat. El test Shapiro-Wilk ens ho confirma. 

```{r,eval=TRUE,echo=TRUE}
shapiro.test(aov511$residuals)
```
### Homocedasticitat dels residus
>Els gràfics “Residuals vs Fitted”, “Scale-Location” i “Residuals vs Factor levels” donen informació sobre la homocedasticitat dels residus. Interpreteu aquests gràfics.

Volem comprovar que la variància dels residus és igual al llarg de la regressió lineal. A  “Residuals vs Fitted” veiem aquest comportament. "Scale locations" ens mostra si els residus es distribueixen per igual en els rangs de predictors. "Residual vs Factor levels" ens ajuda a identificar punts de dades influents al model. En els tres gràfics veiem que la mitjana dels residus és una línia horitzontal i centrada en el 0, fet que ens informa de que no hi ha gran quantitat de outliners que denotin biaix al nostre model.

Si fem el Bertlett test, veiem que el resultat ens indica el mateix que els gràfics, estem en condicions de homocedasticitat dels residus. 

```{r,eval=TRUE,echo=TRUE}
bartlett.test(Sales~ShelveLoc,data=childrenSeatsDataFrame)
```

## ANOVA no paramètric

>Si la validació de les premisses de normalitat i homocedasticitat no es verifiquen es pot aplicar un test no paramètric, per exemple el test de Kruskal-Wallis.</br>
Apliqueu un test de Kruskal-Wallis per contrastar si hi ha diferències entre les botigues segon on s’exposa (ShelveLoc) pel que fa a les vendes (Sales) només a les observacions amb Advertising major que el valor de la mediana.

```{r,eval=TRUE,echo=TRUE}
medianAdvertising<- median(childrenSeatsDataFrame$Advertising)
childrenSeatsDataFrame_MoreAds<-subset(childrenSeatsDataFrame,Advertising > medianAdvertising)
kruskal.test(Sales~ShelveLoc, data=childrenSeatsDataFrame_MoreAds)

boxplot(Sales~ShelveLoc,
  data=childrenSeatsDataFrame_MoreAds,
  main="Vendes vs posició amb Advertising per sobre la mediana",
  xlab="Posició als prestatges",
  ylab="Vendes (milers)",
  col="orange",
  border="brown"
)
```

###  Interpreteu els resultats

En aquesta prova es plantegen com a hipòtesis nul·la que les mostres de dades associades a les diferents categories d'una variable pertanyen a la mateixa població. Com a alternativa tenim que no totes provenen de la mateixa població i que, per tant, no tenen el mateix comportament.

Veiem que obtenim un p-valor extremadament petit, fet que ens porta a rebutjar la hipòtesis nul·la en favor de l'alternativa, assumint que ShelveLoc té influència en Sales per les dades estudiades.

******
# <strong> ANOVA multifactorial (ANOVA)</strong>
******

>A continuació, es vol avaluar l’efecte de més d’un factor sobre la variable Sales on el primer factor sempre serà ShelveLoc. Primer es realitzarà l’anàlisi on el segon factor és US i després, l’anàlisi on el segon factor és Urban.

## Factors: ShelveLoc i US

### Anàlisis visual dels efectes principals i possibles interaccions
>Dibuixeu en un gràfic la variable Sales en funció de ShelveLoc i en funció de US. El gràfic ha de permetre avaluar si hi ha interacció entre els dos factors. 


```{r,eval=TRUE,echo=TRUE}
library(dplyr);

SummaryEx61 <- childrenSeatsDataFrame %>% group_by(ShelveLoc, US)  %>% summarise(Sales = mean(Sales), n = n())

SummaryEx61  %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover"))

library("ggpubr")
ggline(SummaryEx61, x = "ShelveLoc", y = "Sales", color = "US",
       add = c("mean_se", "dotplot"),
       palette = c("#00AFBB", "#E7B800"))

```

En aquest gràfic veiem que hi ha diferències en quant a les mitjanes en vendes segons les dues variables i els seus valors. Per una banda veiem de les vendes són superiors als Estats Units de mitjana, i també veiem que un millor posicionament a la botiga, repercuteix en més vendes, així que tenim efectes de les dues variables. Per altre banda veiem que hi ha interacció entre elles, ja que no tenim línies paral·leles. Sembla que dins dels Estats Units l’efecte del posicionament del producte té major efecte que fora.

###  Adequació del model

```{r,eval=TRUE,echo=TRUE}
aov612 <- aov(Sales~ShelveLoc+US,data=childrenSeatsDataFrame)
plot(aov612)
```

Els gràfics, com en el cas anterior, ens confirmen que estem dins del supòsit d'homogeneïtat dels residus i d'homocedasticitat.

## Factors: ShelveLoc i Urban

###  Anàlisis visual dels efectes principals i possibles 
>Dibuixeu en un gràfic la variable Sales en funció de ShelveLoc i en funció de Urban. El gràfic ha de permetre avaluar si hi ha interacció entre els dos factors. 

```{r,eval=TRUE,echo=TRUE}
Summary62 <- childrenSeatsDataFrame %>% group_by(ShelveLoc, Urban)  %>% summarise(Sales = mean(Sales), n = n())
Summary62 %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover"))

ggline(Summary62, x = "ShelveLoc", y = "Sales", color = "Urban",
       add = c("mean_se", "dotplot"),
       palette = c("#00AFBB", "#E7B800"))

```

En aquest gràfic veiem que, com ja sabem, la posició del producte en la botiga es estadísticament significativa en quant a la mitjana de vendes. En el cas de la variable que descriu les vendes en nuclis urbans o no, gràficament no hi veiem gairebé influència.

******
# <strong> Comparacions múltiples (ANOVA)</strong>
******

>Prenent com a referència el model ANOVA multifactorial, amb els factors ShelveLoc i US, aplicar el test de comparació múltiple Scheffé. Interpreteu el resultat del test i indicar quins grups són diferents significativament entre si.

```{r,eval=TRUE,echo=TRUE}
library(DescTools)

ScheffeTest(aov612) 
```

La prova de Scheffé permet la comparació entre parelles. Es conservadora i s'ha de donar el supòsit d'homoscedasticitat. Veiem en l'aplicació del test sobre el model escollit que totes les comparacions entre les categories són estadísticament significatives. La diferència de mitjanes més gran la trobem a la variable ShelveLoc entre les categories Good i Bad. Podem veure que la relació No-Yes de la variable US, encara que significativa, és la menys diferència entre mitjanes genera.


******
# <strong> Conclusions </strong>
******

Primer de tot em analitzat les variables quantitatives, observant una distribució no simètrica per a Advertaising. Al analitzar les variables categòriques, hem vist que la posició als prestatges sembla tenir influència en les vendes, la localització de la botiga en un entorn urbà o no denota un comportament clarament diferenciat, mentre que sí es ven dins o fora dels EUA sí que té un lleuger efecte. Per altra banda, hem vist que la major part de les vendes es fan en nuclis urbans, dins dels EUA i que el producte es trobava situat a la tenda en una posició intermèdia.

La mitjana de preu de seients de cotxes infantils es troba entre els `r round(intervalPreu[1],1)`\$ i els `r round(intervalPreu[2],1)`\$. Hem volgut crear un model predictiu de la forma:
`r formularEx41`. Analitzant aquest model, hem vist que les variables rellevants són Price, Advertising, Age i, sobretot ShelveLoc.

Ens hem centrat en la relació entre les vendes i ShelveLoc. Hem vist que hi ha evidència estadística de que els seus diferents valors estan associats a grups bens definits en la variable de resposta. Després hem analitzat l'efecte d'aquests valors i hem vist que el nivell “Bad” té un notable efecte negatiu, “Medium” està molt a prop de la mitjana mostral, i “Good” té un clar efecte positiu.

A continuació hem estudiat la relació entre vendes, ShelveLoc i US. Per una banda hem vist que les vendes són superiors als Estats Units de mitjana, i també hem vist que un millor poscionament a la botiga, repercuteix en més vendes. D'altra banda, hem vist que hi ha termes d'interacció entre les dues variables. Després hem estudiat la relació entre vendes, ShelveLoc i Urban. En el cas hem tornat a confirmar que la variable que descriu les vendes en nuclis urbans o no, no sembla tenir influència. 

Per ultim, amb el test Scheffé, hem tornat a confirmar el que sospitàvem, que la diferència de mitjanes en vendes més gran la trobem a la variable ShelveLoc entre les categories Good i Bad.



******
# <strong>Referències</strong>
******

* Alboukadel Kassambara. <i>Regression with Categorical Variables: Dummy Coding Essentials in R</i> [Data de consulta: 17 de juny de 2020] Disponible a: http://www.sthda.com/english/articles/40-regression-analysis/163-regression-with-categorical-variables-dummy-coding-essentials-in-r/

* Rosana Ferrero. <i>¿CÓMO REALIZAR EL ANOVA DE UNA VÍA EN R?</i> [Data de consulta: 17 de juny de 2020] Disponible a: https://www.maximaformacion.es/blog-dat/como-realizar-el-anova-de-una-via-en-r/

* Francisco García García. <i>¿Análisis de la Varianza (ANOVA) con R?</i> [Data de consulta: 17 de juny de 2020] Disponible a: https://biocosas.github.io/R/050_anova.html

* Bommae Kim. <i>¿Análisis de la Varianza (ANOVA) con R?</i></i> [Data de consulta: 17 de juny de 2020] Disponible a: https://data.library.virginia.edu/diagnostic-plots/
